<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Iframe that drops a cookie</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:12px}</style>
</head>
<body>
  <h2>Iframe (site-b)</h2>
  <p id="status">starting...</p>

  <button id="tryDrop">Try to drop cookie via JS</button>
  <button id="reqStorageAccess">Request Storage Access (if needed)</button>

  <script>
    const status = (s) => {
      document.getElementById('status').textContent = s;
      console.log(s);
    };

    // Utility to send structured messages to the parent (postMessage)
    function notifyParent(msg) {
      // For security, replace '*' with the known parent origin if possible.
      // When embedding cross-origin, the parent origin is the top-level origin; in many cases you can use document.referrer to derive it.
      const parentOrigin = document.referrer ? new URL(document.referrer).origin : '*';
      window.parent.postMessage(msg, parentOrigin);
    }

    // Attempt to set a normal cookie with document.cookie
    function dropCookieJS() {
      try {
        // document.cookie cannot set HttpOnly cookies; those must be set server-side
        document.cookie = "iframe_cookie=js-set-value; max-age=3600; path=/github.io Partitioned";
        // read it back (only works if same-origin or cookie available)
        const got = document.cookie.split('; ').find(s => s.startsWith('iframe_cookie='));
        const cookieSet = !!got;
        status('document.cookie set attempt. readback=' + (got || '<none>'));
        notifyParent({ type: 'cookie-set-result', cookieSet, details: got || null });
      } catch (err) {
        status('cookie JS error: ' + err.message);
        notifyParent({ type: 'cookie-set-result', cookieSet: false, details: String(err) });
      }
    }

    // Storage Access API flow (works only in some browsers and typically requires a user gesture)
    async function requestStorageAccess() {
      status('requesting storage access (Storage Access API)...');
      if (document.hasStorageAccess) {
        try {
          const has = await document.hasStorageAccess();
          status('hasStorageAccess() => ' + has);
          if (!has) {
            // user gesture required — call from click handler (we do)
            await document.requestStorageAccess();
            status('requestStorageAccess() succeeded — now try setting cookie');
            dropCookieJS();
          } else {
            status('already has storage access; trying to set cookie');
            dropCookieJS();
          }
        } catch (err) {
          status('Storage Access API error: ' + err.message);
          notifyParent({ type: 'cookie-set-result', cookieSet: false, details: 'storage-access-failed: ' + err.message });
        }
      } else {
        status('Storage Access API not supported in this browser');
        notifyParent({ type: 'cookie-set-result', cookieSet: false, details: 'storage-access-api-unsupported' });
      }
    }

    document.getElementById('tryDrop').addEventListener('click', () => {
      // A click is a user gesture — good for Storage Access API if needed
      dropCookieJS();
    });

    document.getElementById('reqStorageAccess').addEventListener('click', () => {
      requestStorageAccess();
    });

    // Listen to messages from parent
    window.addEventListener('message', (ev) => {
      // optionally verify ev.origin if you expect only a specific parent
      const data = ev.data || {};
      console.log('iframe got message', ev.origin, data);
      if (data && data.type === 'parent-ping') {
        status('received parent ping; attempting to set cookie automatically (for demo)');
        // Try to set cookie on ping (note: may fail in cross-site contexts)
        dropCookieJS();
      }
      if (data && data.type === 'parent-response') {
        status('parent responded: ' + JSON.stringify(data));
      }
    });

    // On load, report presence to parent
    window.addEventListener('load', () => {
      notifyParent({ type: 'iframe-loaded', url: location.href });
      status('iframe loaded, notified parent');
    });

  </script>
</body>
</html>
